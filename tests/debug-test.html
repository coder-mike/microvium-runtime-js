<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div id="mocha"></div>
  <script type="module">
    import Runtime, { useWasmModule } from '../dist/index.mjs';

    const assert = p => { if (!p) { throw new Error('Assertion failed'); } }
    assert.equal = (a, b) => { if (a !== b) { throw new Error(`Assertion failed: ${a} !== ${b}`); } }

    useWasmModule(WebAssembly.compileStreaming(fetch("../build/microvium1.wasm")));

    // 1. Paste the snapshot here (e.g. from build/dbg-passing-functions-bytes.js):
    const snapshot = [0x8,0x1c,0x0,0x0,0xe8,0x0,0x6a,0x35,0x3,0x0,0x0,0x0,0x1c,0x0,0x20,0x0,0x24,0x0,0x24,0x0,0x32,0x0,0x38,0x0,0xcc,0x0,0xda,0x0,0x0,0x0,0x1,0x0,0x0,0x0,0x8d,0x0,0xd9,0x0,0x1,0x0,0x1,0x0,0x71,0x0,0x7d,0x0,0x85,0x0,0xd5,0x0,0x4d,0x0,0x3d,0x0,0x5d,0x0,0x0,0x0,0xd,0x40,0x62,0x65,0x66,0x6f,0x72,0x65,0x20,0x61,0x77,0x61,0x69,0x74,0x0,0x0,0xc,0x40,0x61,0x66,0x74,0x65,0x72,0x20,0x61,0x77,0x61,0x69,0x74,0x0,0x0,0x0,0x9,0x40,0x72,0x65,0x73,0x75,0x6c,0x74,0x3a,0x20,0x0,0x0,0x2,0x60,0x0,0x0,0x2,0x60,0x1,0x0,0x4,0x50,0x21,0x1,0x22,0x23,0x78,0x3,0x60,0x0,0x0,0x0,0x3,0x50,0x3,0x7d,0xd,0x0,0x0,0x0,0x3,0x50,0x1,0x32,0x31,0x7d,0xd,0x0,0x2,0x50,0x89,0x2,0x0,0x1,0x78,0x81,0x1,0x60,0x0,0x0,0x8,0x50,0x7d,0xa,0x3,0x88,0x19,0x0,0x89,0x1,0x0,0x1,0x88,0x3d,0x0,0x78,0x82,0x89,0x0,0x0,0x1,0x84,0x1,0x83,0x6,0x58,0x85,0x1,0x3,0xa0,0x89,0x1,0x0,0x1,0x88,0x4d,0x0,0x78,0x82,0x89,0x1,0x0,0x1,0x88,0x5d,0x0,0x13,0x6c,0x78,0x82,0x67,0x1,0x7d,0xb,0x69,0x0,0x6d,0x0,0x99,0x0,0x19,0x0,0x2,0x0,0x19,0x0,0x1,0x0,0xc,0xc0,0x5,0x0,0x5,0x0,0x3,0x80,0xb,0x0,0xff,0xff,0x1,0x0];


    // 3. Paste the test code here:
    // --------------------------------- BEGIN --------------------------------

    let resolve;
    async function asyncHostFunc() {
      // Note: Microvium can't await a host promise but the host can await it and
      // expose an async function
      return await new Promise(resolve_ => resolve = resolve_);
    }

    const printed = [];
    function print(s) {
      printed.push(s);
    }

    const vm = await Runtime.restore(snapshot, { 0: asyncHostFunc, 1: print });
    const { 0: run } = vm.exports;

    run();
    assert(resolve);
    assert.deepEqual(printed, ['before await']);

    resolve(42);

    // ---------------------------------- END ---------------------------------

    // 3. Run `npx serve` in the root project folder, open
    //    http://localhost:3000/tests/debug-test.html in Chrome and debug in
    //    devtools.
  </script>
</body>
</html>