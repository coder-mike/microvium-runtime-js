<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div id="mocha"></div>
  <script type="module">
    import Runtime, { useWasmModule } from '../dist/index.mjs';

    const assert = p => { if (!p) { throw new Error('Assertion failed'); } }
    assert.equal = (a, b) => { if (a !== b) { throw new Error(`Assertion failed: ${a} !== ${b}`); } }

    useWasmModule(WebAssembly.compileStreaming(fetch("../build/microvium1.wasm")));

    // 1. Paste the snapshot here (e.g. from build/dbg-passing-functions-bytes.js):
    const snapshot = [0x8,0x1c,0x0,0x0,0x6e,0x0,0x5f,0x74,0x3,0x0,0x0,0x0,0x1c,0x0,0x1e,0x0,0x22,0x0,0x22,0x0,0x30,0x0,0x34,0x0,0x68,0x0,0x6e,0x0,0x1,0x0,0x1,0x0,0x55,0x0,0x6d,0x0,0x1,0x0,0x1,0x0,0x1,0x0,0x1,0x0,0x1,0x0,0x1,0x0,0x39,0x0,0x45,0x0,0x0,0x0,0x8,0x40,0x48,0x65,0x6c,0x6c,0x6f,0x2c,0x20,0x0,0x0,0x0,0x7,0x40,0x57,0x6f,0x72,0x6c,0x64,0x21,0x0,0x0,0x0,0x0,0x2,0x60,0x0,0x0,0x3,0x50,0x89,0x0,0x0,0x1,0x88,0x39,0x0,0x78,0x82,0x89,0x0,0x0,0x1,0x88,0x45,0x0,0x78,0x82,0x1,0x60,0x51,0x0,0x19,0x0,0x1,0x0];


    // 3. Paste the test code here:
    // --------------------------------- BEGIN --------------------------------
    let printOut = '';
    const print = (s) => printOut += s;

    let breakpointWasHit = undefined;
    let printoutAtBreakpoint = undefined;
    const breakpointHit = (a) => {
      breakpointWasHit = a;
      printoutAtBreakpoint = printOut;
    }

    const vm = await Runtime.restore(snapshot, { [1]: print }, { breakpointHit });

    // See build/dbg-breakpoint.disassembly for the addresses. Here I'm
    // breakpointing on the second call to `print`
    vm.setBreakpoint(0x006f);

    vm.exports[1]();
    assert.equal(breakpointWasHit, 0x006F);
    assert.equal(printoutAtBreakpoint, 'Hello, ');
    assert.equal(printOut, 'Hello, World!');

    // ---------------------------------- END ---------------------------------

    // 3. Run `npx serve` in the root project folder, open
    //    http://localhost:3000/tests/debug-test.html in Chrome and debug in
    //    devtools.
  </script>
</body>
</html>